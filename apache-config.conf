# Apache Configuration for Chick'N Needs
# This file contains the complete Apache configuration for both main site and API

# Main site virtual host
<VirtualHost *:80>
    ServerName chicknneeds.shop
    ServerAlias www.chicknneeds.shop
    DocumentRoot /var/www/chicknneeds/client/dist
    
    # Enable compression
    LoadModule deflate_module modules/mod_deflate.so
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
    
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    
    # Handle client-side routing
    <Directory /var/www/chicknneeds/client/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Fallback to index.html for client-side routing
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Cache static assets
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header append Cache-Control "public, immutable"
    </LocationMatch>
    
    # API proxy
    ProxyPreserveHost On
    ProxyPass /api/ http://localhost:4000/api/
    ProxyPassReverse /api/ http://localhost:4000/api/
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/chicknneeds_error.log
    CustomLog ${APACHE_LOG_DIR}/chicknneeds_access.log combined
</VirtualHost>

# API subdomain virtual host
<VirtualHost *:80>
    ServerName api.chicknneeds.shop
    DocumentRoot /var/www/chicknneeds
    
    # API proxy
    ProxyPreserveHost On
    ProxyPass / http://localhost:4000/
    ProxyPassReverse / http://localhost:4000/
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/api_chicknneeds_error.log
    CustomLog ${APACHE_LOG_DIR}/api_chicknneeds_access.log combined
</VirtualHost>
